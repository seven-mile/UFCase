<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
  </ItemGroup>
  <PropertyGroup Label="Globals">
    <VCProjectVersion>17.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{22aeb5f9-4edf-4d9e-9e67-6c298f730e89}</ProjectGuid>
    <RootNamespace>UFCaseProxyStub</RootNamespace>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
    <!-- Output to UFCase directly -->
    <OutDir>$(SolutionDir)$(Platform)\$(Configuration)\UFCase\</OutDir>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>true</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
    <ConfigurationType>DynamicLibrary</ConfigurationType>
    <UseDebugLibraries>false</UseDebugLibraries>
    <PlatformToolset>v143</PlatformToolset>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <CharacterSet>Unicode</CharacterSet>
  </PropertyGroup>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>
  <ImportGroup Label="Shared">
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>
  <PropertyGroup Label="UserMacros" />
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <IncludePath>$(SolutionDir)UFCase.Host\RpcProxyPolyfill;$(IncludePath)</IncludePath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <IncludePath>$(SolutionDir)UFCase.Host\RpcProxyPolyfill;$(IncludePath)</IncludePath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <IncludePath>$(SolutionDir)UFCase.Host\RpcProxyPolyfill;$(IncludePath)</IncludePath>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <IncludePath>$(SolutionDir)UFCase.Host\RpcProxyPolyfill;$(IncludePath)</IncludePath>
  </PropertyGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;UFCASEPROXYSTUB_EXPORTS;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <EnableUAC>false</EnableUAC>
      <ModuleDefinitionFile>Source.def</ModuleDefinitionFile>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>_DEBUG;UFCASEPROXYSTUB_EXPORTS;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <EnableUAC>false</EnableUAC>
      <ModuleDefinitionFile>Source.def</ModuleDefinitionFile>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;UFCASEPROXYSTUB_EXPORTS;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding Condition="'$(UseDynamicDebugging)' != 'true'">true</EnableCOMDATFolding>
      <OptimizeReferences Condition="'$(UseDynamicDebugging)' != 'true'">true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <EnableUAC>false</EnableUAC>
      <ModuleDefinitionFile>Source.def</ModuleDefinitionFile>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
    <ClCompile>
      <WarningLevel>Level3</WarningLevel>
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <IntrinsicFunctions>true</IntrinsicFunctions>
      <SDLCheck>true</SDLCheck>
      <PreprocessorDefinitions>NDEBUG;UFCASEPROXYSTUB_EXPORTS;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <PrecompiledHeader>NotUsing</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding Condition="'$(UseDynamicDebugging)' != 'true'">true</EnableCOMDATFolding>
      <OptimizeReferences Condition="'$(UseDynamicDebugging)' != 'true'">true</OptimizeReferences>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <EnableUAC>false</EnableUAC>
      <ModuleDefinitionFile>Source.def</ModuleDefinitionFile>
    </Link>
  </ItemDefinitionGroup>
  <ItemGroup>
    <ClInclude Include="framework.h" />
    <ClInclude Include="pch.h" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="dlldata.c" />
    <ClCompile Include="dllmain.cpp" />
    <ClCompile Include="pch.cpp">
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Release|x64'">Create</PrecompiledHeader>
      <PrecompiledHeader Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">Create</PrecompiledHeader>
    </ClCompile>
  </ItemGroup>
  <ItemGroup>
    <None Include="merge_dlldata.py" />
    <None Include="Source.def" />
  </ItemGroup>
  <!-- Process input winmds. -->
  <ItemGroup>
    <ProjectReference Include="..\UFCase.Host.Manifest\UFCase.Host.Manifest.csproj">
      <Project>{731603da-8257-4e50-a9a9-c47d3c9f8233}</Project>
    </ProjectReference>
    <ProjectReference Include="..\UFCase.Host\UFCase.Host.vcxproj">
      <Project>{72710aa5-7cc4-4f1d-9560-89cb778e65f5}</Project>
    </ProjectReference>
    <ProjectReference Include="..\UFCase\UFCase.vcxproj">
      <Project>{40ce98ad-3b3a-4c6d-9c01-2116eb9d5834}</Project>
    </ProjectReference>
  </ItemGroup>
  <!-- Define the generated files tracking ItemGroup -->
  <ItemGroup>
    <_GeneratedFiles Include="UFCase.Host.Manifest.h;UFCase.Host.Manifest_p.h;UFCase.Host.Manifest_i.c;UFCase.Host.Manifest_p.c;UFCase.Host.Manifest_d.c;UFCase.Isolation.h;UFCase.Isolation_p.h;UFCase.Isolation_i.c;UFCase.Isolation_p.c;UFCase.Isolation_d.c;dlldata.c" />
  </ItemGroup>
  <!-- Input WinMD files -->
  <ItemGroup>
    <_WinMDPaths Include="$(SolutionDir)$(Platform)\$(Configuration)\UFCase\UFCase.Host.Manifest.winmd" />
    <_WinMDPaths Include="$(SolutionDir)$(Platform)\$(Configuration)\UFCase\UFCase.Isolation.winmd" />
  </ItemGroup>
  <Target Name="CheckPython" BeforeTargets="ProcessWinMD">
    <Exec Command="python --version" IgnoreExitCode="true" ConsoleToMSBuild="true">
      <Output TaskParameter="ExitCode" PropertyName="PythonExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="PythonVersionOutput" />
    </Exec>
    <Error Condition="'$(PythonExitCode)' != '0'" Text="Python is not installed or not found in PATH" />
    <Message Importance="high" Text="Found Python: $(PythonVersionOutput)" />
  </Target>
  <!-- Main target for processing WinMD files -->
  <Target Name="ProcessWinMD" BeforeTargets="ClCompile" Inputs="@(_WinMDPaths)" Outputs="@(_GeneratedFiles)">
    <!-- Setup working paths and tools -->
    <PropertyGroup>
      <WinMDToolsPath Condition="'$(WinMDToolsPath)'==''">"$(WindowsSdkDir)bin\$(TargetPlatformVersion)\$(Platform)"</WinMDToolsPath>
      <_ProxyStubWorkspace>$(ProjectDir)$(IntDir)ProxyStub</_ProxyStubWorkspace>
    </PropertyGroup>
    <!-- Define metadata for processing -->
    <ItemGroup>
      <WinMDFiles Include="@(_WinMDPaths)">
        <BaseName>$([System.IO.Path]::GetFileNameWithoutExtension('%(Identity)'))</BaseName>
      </WinMDFiles>
    </ItemGroup>
    <ItemGroup>
      <WinMDFiles Update="@(WinMDFiles)">
        <IdlFileName>%(BaseName).idl</IdlFileName>
        <HeaderFile>$(MSBuildProjectDirectory)\%(BaseName).h</HeaderFile>
        <ProxyHeaderFile>$(MSBuildProjectDirectory)\%(BaseName)_p.h</ProxyHeaderFile>
        <IFile>$(MSBuildProjectDirectory)\%(BaseName)_i.c</IFile>
        <ProxyFile>$(MSBuildProjectDirectory)\%(BaseName)_p.c</ProxyFile>
        <DllDataFile>$(MSBuildProjectDirectory)\%(BaseName)_d.c</DllDataFile>
      </WinMDFiles>
    </ItemGroup>
    <!-- Create workspace directory -->
    <MakeDir Directories="$(_ProxyStubWorkspace)" Condition="!Exists('$(_ProxyStubWorkspace)')" />
    <!-- Validate input files exist -->
    <Error Condition="!Exists('%(WinMDFiles.Identity)')" Text="Required WinMD file not found: %(WinMDFiles.Identity)" />
    <!-- Process each WinMD file -->
    <PropertyGroup>
      <PlatformEnv Condition="'$(Platform)'=='x64'">x64</PlatformEnv>
      <PlatformEnv Condition="'$(Platform)'=='ARM64'">arm64</PlatformEnv>
    </PropertyGroup>
    <Error Condition="'$(PlatformEnv)'==''" Text="Unsupported client platform." />
    <ItemGroup>
      <_ProcessItem Include="@(WinMDFiles)">
        <Command1>WinMdIdl.exe /outdir:"$(_ProxyStubWorkspace)" "%(Identity)"</Command1>
        <Command2>MIdl.exe /env $(PlatformEnv) /winrt /ns_prefix /dlldata "%(DllDataFile)" /metadata_dir "$(WindowsSDK_UnionMetadataPath)" /I "$(_ProxyStubWorkspace)" /out "$(MSBuildProjectDirectory)" "$(_ProxyStubWorkspace)\%(IdlFileName)"</Command2>
      </_ProcessItem>
    </ItemGroup>
    <!-- Execute the generation commands -->
    <Exec Command="%(_ProcessItem.Command1)" WorkingDirectory="$(MSBuildProjectDirectory)" Outputs="$(_ProxyStubWorkspace)\%(_ProcessItem.IdlFileName)" />
    <Exec Command="%(_ProcessItem.Command2)" WorkingDirectory="$(MSBuildProjectDirectory)" Outputs="%(_ProcessItem.HeaderFile);%(_ProcessItem.ProxyHeaderFile);%(_ProcessItem.IFile);%(_ProcessItem.ProxyFile);%(_ProcessItem.DllDataFile)" />
    <!-- Merge DllData files -->
    <Message Text="Merging DllData files... Cmd: python merge_dlldata.py @(WinMDFiles->'%(DllDataFile)', ' ')" Importance="high" />
    <Exec Command="python merge_dlldata.py @(WinMDFiles->'%(DllDataFile)', ' ') &gt; $(ProjectDir)dlldata.c" WorkingDirectory="$(MSBuildProjectDirectory)" Outputs="dlldata.c" />
    <!-- Patch IIterable<IInspectable> type -->
    <Exec Command="powershell -Command &quot;(Get-Content '$(ProjectDir)UFCase.Isolation_p.h').Replace('__FIIterable_1_IInspectable **result);', 'IInspectable **result);') | Set-Content '$(ProjectDir)UFCase.Isolation_p.h'&quot;" />
    <!-- Add generated files to compilation -->
    <ItemGroup>
      <ClInclude Include="%(WinMDFiles.HeaderFile)" />
      <ClInclude Include="%(WinMDFiles.ProxyHeaderFile)" />
      <ClCompile Include="%(WinMDFiles.IFile)">
        <CompileAs>CompileAsC</CompileAs>
      </ClCompile>
      <ClCompile Include="%(WinMDFiles.ProxyFile)">
        <CompileAs>CompileAsC</CompileAs>
      </ClCompile>
    </ItemGroup>
  </Target>
  <!-- Clean target for generated files -->
  <Target Name="CleanProcessWinMD" BeforeTargets="Clean">
    <!-- Delete generated files -->
    <Delete Files="@(_GeneratedFiles)" TreatErrorsAsWarnings="true">
      <Output TaskParameter="DeletedFiles" ItemName="_CleanedFiles" />
    </Delete>
    <!-- Remove workspace directory -->
    <RemoveDir Directories="$(ProjectDir)$(IntDir)ProxyStub" Condition="Exists('$(ProjectDir)$(IntDir)ProxyStub')" />
    <!-- Log cleaning results -->
    <Message Text="Cleaned ProxyStub generated files: @(_CleanedFiles)" Importance="high" Condition="'@(_CleanedFiles)' != ''" />
  </Target>
  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
  <ImportGroup Label="ExtensionTargets">
  </ImportGroup>
</Project>